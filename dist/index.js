var handle;(()=>{"use strict";var e={d:(t,a)=>{for(var l in a)e.o(a,l)&&!e.o(t,l)&&Object.defineProperty(t,l,{enumerable:!0,get:a[l]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Album:()=>l,Music:()=>i,albumFunc:()=>n,db:()=>s,musicFunc:()=>c});class a extends HTMLElement{connectedCallback(){let e=this.getElementsByTagName("card-album-title"),t=this.getElementsByTagName("card-album-text"),a=this.getAttribute("image-src"),l=this.getAttribute("album-idx"),i=document.createElement("div"),n=document.createElement("img"),c=document.createElement("h5"),s=document.createElement("p");for(this.classList.add("col-6"),i.classList.add("card","card-border-none","mb-3"),i.setAttribute("onclick",`render('/page/album/${l}')`),n.classList.add("card-img-square"),c.classList.add("card-title","mt-2"),s.classList.add("card-text"),n.setAttribute("src",a),n.setAttribute("onerror","this.src='/static/image/album.jpg'"),c.innerText=e[0].innerText,s.innerText=t[0].innerText;this.firstChild;)this.removeChild(this.firstChild);i.appendChild(n),i.appendChild(c),i.appendChild(s),this.appendChild(i)}}class l{constructor(){}async create(e){return(await fetch("/api/album",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`album_title=${e.album_title}&album_text=${e.album_text}&album_image=${e.album_image}`})).json()}async read(e){let t="all"==e.album_idx?"":e.album_idx;return(await fetch(`/api/album/${t}`,{method:"GET"})).json()}async delete(e){return(await fetch(`/api/album/${e.album_idx}`,{method:"DELETE"})).json()}}class i{constructor(){}async upload(e){return(await fetch("/api/music",{method:"POST",body:e})).json()}async get(e){return(await fetch(`/api/music/${e}`,{method:"GET"})).json()}}const n={addAlbum:async function(){let e=new handle.Album,t={album_title:document.querySelector("#form_album_title").value,album_text:document.querySelector("#form_album_text").value,album_image:document.querySelector("#form_album_image").value};await e.create(t)},deleteAlbum:async function(){let e=new handle.Album,t={album_idx:location.pathname.split("/")[3]},a=await e.delete(t);console.log(a)},loadAlbum:async function(e="all"){let t=new handle.Album,a=document.querySelector("#list_album"),l={album_idx:e};(await t.read(l)).result.forEach((e=>{let t=document.createElement("card-album"),l=document.createElement("card-album-title"),i=document.createElement("card-album-text");t.setAttribute("image-src",e.album_image),t.setAttribute("album-idx",e.idx),l.innerText=e.album_title,i.innerText=e.album_text,t.appendChild(l),t.appendChild(i),a.insertAdjacentElement("beforeend",t)}))},loadAlbumSelect:async function(){let e=new handle.Album,t=document.querySelector("#form_music_albums");(await e.read({album_idx:"all"})).result.forEach((e=>{let a=document.createElement("option");a.setAttribute("value",e.idx),a.innerText=e.album_title,t.insertAdjacentElement("beforeend",a)}))}},c={object:{audio:new Audio,currentAudioUrl:"",currentPlaylistUrl:[],existAudio:!1,isPlaylist:!1},modal:{player:new bootstrap.Modal(document.getElementById("player_music"),{keyboard:!1})},uploadMusic:async function(){let e=new handle.Music,t=document.querySelector("#form_music_file").files[0]||"",a=document.querySelector("#form_music_albums").selectedIndex,l={album_idx:document.querySelector("#form_music_albums").options[a].value,music_title:document.querySelector("#form_music_title").value};if(""!=t){const a=new FormData;a.append("body",JSON.stringify(l)),a.append("file",t),1==(await e.upload(a)).status?dds.toast({content:"성공적으로 업로드 했어요"}):dds.toast({content:"문제 발새애애앵"})}},getMusicFromAlbum:async function(e){let t=new handle.Music,a=document.querySelector("#list_music"),l=await t.get(e),i=0;document.querySelector("#button_music_play").setAttribute("onclick",`handle.musicFunc.playMusic('/uploads/${l.result[0].music_filename}')`),l.result.forEach((async e=>{let t=document.createElement("tr"),l=document.createElement("th"),n=document.createElement("td"),c=document.createElement("td"),s=await this.loadOffline(`/uploads/${e.music_filename}`);i+=1,t.setAttribute("onclick",`handle.musicFunc.playMusic('/uploads/${e.music_filename}')`),l.innerText=i,n.innerText=e.music_title,1==s.status&&(c.innerHTML='<i class="fas fa-download text-secondary icon-sm"></i>'),t.appendChild(l),t.appendChild(n),t.appendChild(c),a.insertAdjacentElement("beforeend",t),await this.setPlaylist(`/uploads/${e.music_filename}`)}))},playMusic:async function(e){let t=await this.loadOffline(e);if(1==t.status){let a=new Blob([t.result]),l=window.URL.createObjectURL(a);this.replacePlaylist(e,l),e=l,console.log("off")}this.object.currentAudioUrl!=e&&(console.log("music change"),this.object.audio.pause(),this.object.audio=""),1==this.object.existAudio&&this.object.currentAudioUrl==e?(this.object.audio.play(),this.modal.player.show()):(this.object.currentAudioUrl=e,this.object.audio=new Audio(e),this.object.audio.play(),this.object.existAudio=!0,this.modal.player.show(),document.querySelector("#player_btn_play").setAttribute("onclick",`handle.musicFunc.playMusic('${e}')`)),setInterval((async()=>{document.querySelector("#player_range").value=await this.getCurrentTime(),100==document.querySelector("#player_range").value&&this.playNextMusic()}),600),this.showMusicControllerButton("player_btn_pause")},playNextMusic:async function(){let e=this.object.currentPlaylistUrl.indexOf(this.object.currentAudioUrl)+1;if(e==this.object.currentPlaylistUrl.length)await this.pauseMusic();else{let t=this.object.currentPlaylistUrl[e];await this.playMusic(t)}},playRandomMusic:async function(){this.object.currentPlaylistUrl.sort((()=>Math.random()-.5)),this.playMusic(this.object.currentPlaylistUrl[0])},pauseMusic:async function(){this.object.existAudio&&this.object.audio.pause(),this.showMusicControllerButton("player_btn_play")},setCurrentTime:async function(){let e=document.querySelector("#player_range").value;this.object.audio.currentTime=e*this.object.audio.duration/100},getCurrentTime:async function(){return this.object.audio.currentTime/this.object.audio.duration*100},setPlaylist:async function(e){this.object.currentPlaylistUrl.push(e)},replacePlaylist:async function(e,t){let a=this.object.currentPlaylistUrl.indexOf(e);a>=0&&(this.object.currentPlaylistUrl.splice(a,1,t),console.log(this.object.currentPlaylistUrl))},saveOffline:async function(e){let t=await fetch(e);const a=await t.blob();await handle.db.insert(e,a)},downloadAllMusic:async function(){let e=new handle.Music,t=location.pathname.split("/")[3];(await e.get(t)).result.forEach((async e=>{await this.saveOffline(`/uploads/${e.music_filename}`)}))},loadOffline:async function(e){let t=await handle.db.select(e);return null!=t?{status:1,result:t}:{status:-1}},showMusicControllerButton:async function(e){let t=["player_btn_play","player_btn_pause"];for(let e=0;e<t.length;e++)document.querySelector(`#${t[e]}`).classList.add("div-hide");document.querySelector(`#${e}`).classList.remove("div-hide")}},s={connect:{name:"dmp",db:void 0,isdbavailable:!1},open:async function(){let e=window.indexedDB.open(this.connect.name);e.onsuccess=()=>{let t=e.result;this.connect.db=t,this.connect.isdbavailable=!0,t.objectStoreNames.contains("music")||t.createObjectStore("music",{})},e.onupgradeneeded=()=>{let t=e.result;t.objectStoreNames.contains("music")||t.createObjectStore("music",{})}},insert:async function(e,t){let a=this.connect.db.transaction("music","readwrite").objectStore("music").add(t,e);a.onsuccess=function(){console.log("Saved")},a.onerror=function(){console.log("Error")}},select:async function(e){let t=this.connect.db.transaction("music","readwrite").objectStore("music").get(e);return await new Promise(((e,a)=>{t.onsuccess=function(t){e(t.target.result)}}))}};customElements.define("card-album",a),handle=t})();